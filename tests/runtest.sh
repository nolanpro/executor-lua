set -e; set -x

export API_TOKEN=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImp0aSI6IjNhMjMwNjMwMTVkZGYzNGU2MWE2ODUwNTY5ZWVjN2EwMzQzMmQyMGMwZjEzZGYzZmE2NWIzZWZjYmJhNmY1ODI0MzNkMjZhMWJkMDMzY2YwIn0.eyJhdWQiOiIxIiwianRpIjoiM2EyMzA2MzAxNWRkZjM0ZTYxYTY4NTA1NjllZWM3YTAzNDMyZDIwYzBmMTNkZjNmYTY1YjNlZmNiYmE2ZjU4MjQzM2QyNmExYmQwMzNjZjAiLCJpYXQiOjE1NTI2MDc0MjUsIm5iZiI6MTU1MjYwNzQyNSwiZXhwIjoxNTg0MjI5ODI1LCJzdWIiOiIxIiwic2NvcGVzIjpbXX0.wDfo8dPg4IoFvvrtMQa-M6IgN1L3XeQ4ioBu1nNVeW0p8X-PmseyuS0JOXCGJKom5ni5_sG4VmVLI5jx02XItY_zC7eLtb8jhlgviZgVVRAoUH8kxt-V12duhe1LicuDDv-yfxnYgysVD2n87ba_RIUop0i6QOAPYrAZnDtRY2AeUXW0_tDbHKeXTgH9kdIlL2fzhPTUSDB5p5MjdgR0LsV5EdbnMu4reTutRXQfj6JR1zDNcdE7vfq5ww1llYS0bI64al11ZgChtCVY2FCoO79b2x3g9br6ge6JRAjAwJ_lMsnIcWSwMSkKvFY6YjuCrkC_lUwC2y9vASxYDCa-KLx0cGC9cyKd9vnXBWlj5YG_nRPSuFFcDkfMBHWAYENG-8XLX-y68OwPWsz_RmV7fv7HsPdnk1i3XL79OjmAYZ8qu-RKNulrvQWRphX_SK9X9FoZ1507WLdn22kgMgq5N2XpbbO2EZ-7-fD7aOB_mO4e0r9P7dLoGhRoy5P9F5eQEX___8XChFVqZ5xj6yCFLIc6EcO4wudbdeZODT65770A5IUdvBpC35QkDVhgsV4sZOy1SEa1P57T6Ge2jEf4X5h_npglQz4QaTPZCj4dvsHGuRBPjwLF_jEM5TgdZyyWXrfj_O5dptI6IlDec72rKB_0g7UJRMndpITbkixhsLU
export API_HOST=http://bpm4.local.processmaker.com/api/1.0
ROCKFILE=pmsdk-1.0.0-1.all.rock
REPO=ProcessMaker/pm4-sdk-lua
BRANCH=master

mkdir -p /opt/executor
curl -f -L -o /opt/executor/${ROCKFILE} https://github.com/${REPO}/raw/${BRANCH}/dist/${ROCKFILE}

pushd ../src
  cp bootstrap.lua /opt/executor/bootstrap.lua
popd

pushd sdk
  cp script.lua /opt/executor/script.lua
  cp *.json /opt/executor/
popd

pushd /opt/executor
  luarocks install /tmp/${ROCKFILE} --local
  lua5.3 bootstrap.lua
  cat output.json
popd